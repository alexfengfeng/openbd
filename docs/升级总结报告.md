# 升级总结报告

基于 [需求改进.md](file:///d:/AI/openbd/需求改进.md) 的功能升级已完成，并补齐测试与文档。

## 1. 变更列表（核心）

### 工作空间

- 新增最近访问字段：`Workspace.lastVisitedAt`
- 新增接口：POST `/api/workspaces/[id]/visit`
- 调整列表排序：GET `/api/workspaces` 按 `lastVisitedAt desc` 优先
- 新增 WorkspaceSwitcher（搜索 + 最近使用 + 新建入口）
- 新增全局快捷键：Ctrl/⌘1-4 切换最近工作空间

### 需求（看板/编辑/导入）

- 新增排序字段：`Requirement.order`（DB 映射为 `sort_order`）
- 看板实现拖拽：跨列拖拽后批量更新状态与顺序
- 新增接口：PATCH `/api/requirements/reorder`
- 新增快速编辑（Quick Edit）：卡片右上角铅笔按钮 + AI 标题建议
- 新增批量导入：POST `/api/requirements/import`（JSON）
- 新增模板与语音输入（渐进增强）：创建页模板选择 + 浏览器语音识别（支持则显示）

### AI

- /api/ai/parse-requirement：支持 DeepSeek（OpenAI SDK 兼容）
- 增加缓存与限流；未配置 `DEEPSEEK_API_KEY` 时自动降级为本地规则解析
- 新增接口：POST `/api/ai/suggest-title`

### 效率体验

- 命令面板（Ctrl/⌘K）：搜索工作空间 + 创建快捷操作
- 全局快捷键：C 创建需求、/ 聚焦搜索、E 触发快速编辑

## 2. 向后兼容性说明

- 数据库变更全部为新增字段（nullable 或默认值），不影响已有数据读写。
- 现有 API 保持兼容：以新增接口/新增可选字段为主。
- AI 解析接口保留返回结构 `{ parsed: ... }`；同时允许返回 `cached/degraded` 标记字段。

## 3. 测试与质量门禁

### 测试体系

- 单元/集成：Vitest + Testing Library
- E2E：Playwright（含 dev server 启动与网络 mock）

### 覆盖率

已通过覆盖率门槛：

- Statements/Lines ≥ 80%
- Functions ≥ 80%
- Branches ≥ 70%

### 回归结果（本地）

- `pnpm build`：通过
- `pnpm lint`：通过（含少量可接受的 warning）
- `pnpm test:coverage`：通过
- `pnpm test:e2e`：通过

## 4. 性能对比与说明

当前仓库缺少“升级前基准”的可复现脚本与历史基线数据，因此无法在本地环境直接计算“升级前后 95%”对比值。

已补齐的可复现门禁：

- `pnpm build` 作为构建与产物体积的基线
- `pnpm test:e2e` 作为关键链路回归门禁

建议在 staging 按部署手册记录以下基线并固化到 CI：

- 首页/登录/仪表板首屏 TTFB/P95
- `/api/workspaces`、`/api/requirements` 的 P95 延迟与错误率

## 5. 风险点与后续优化建议

- CommandPalette 的可访问性提示：建议为命令面板补齐 DialogTitle/Description（不影响功能，但建议完善）。
- 看板拖拽排序：当前按 `order` 重新编号，若需要跨端并发更强一致性，可引入“稀疏排序”策略（如步长 1000）。
- 批量导入：当前为 best-effort 写入；若需要强一致性可改为事务 + 幂等导入。

