# 功能升级清单与分阶段计划

本文档基于 [需求改进.md](file:///d:/AI/openbd/需求改进.md) 逐条拆解形成，用于指导本仓库的全面功能升级与验收。

## 1. 升级范围总览

### 1.1 P0（必须）

1. 工作空间快速切换（替代当前“默认选第一个工作空间”）
2. AI 智能解析（从关键词匹配升级到真实大模型集成；保留无 Key 的降级能力）
3. 看板拖拽更新状态（卡片跨列拖拽，1 次操作完成状态变更）
4. 数据模型增强：Workspace.lastVisitedAt、Requirement.order（并保持兼容）

### 1.2 P1（重要）

1. 快速编辑对话框（原地编辑标题/描述/状态/优先级）
2. 命令面板（Ctrl/⌘K）
3. 全局快捷键（C 创建、E 快速编辑、/ 聚焦搜索、Ctrl/⌘1-4 最近工作空间等）
4. AI 标题建议（Quick Edit 内“AI 优化标题”）
5. AI 结果缓存与限流

### 1.3 P2（增强）

1. 需求模板系统
2. 语音输入（可先实现前端能力与占位接口）
3. 批量导入（API + 基础校验）

## 2. 逐条功能点与变更要求清单

### 2.1 工作空间快速切换（P0）

**现状问题**
- Dashboard Layout 硬编码默认选第一个工作空间，缺少用户态切换与最近访问排序。

**功能要求**
- 侧边栏提供工作空间切换器：搜索、最近使用、创建入口。
- 最近使用工作空间列表本地持久化，至少保存最近 5 个。
- 切换空间应保持当前页面语义（例如在 board/requirements 页面仅替换 workspaceId）。
- 服务端记录最后访问时间（用于排序与跨端一致性）。

**数据/接口变更**
- Prisma：Workspace 增加 lastVisitedAt（可空）并加索引。
- 新增接口：POST /api/workspaces/[id]/visit，用于写入 lastVisitedAt（鉴权 + 成员校验）。
- 修改接口：GET /api/workspaces 默认按 lastVisitedAt desc（空值置后）+ updatedAt desc 排序。

**验收标准**
- 进入 Dashboard 不再固定选择第一个工作空间；切换空间 < 1s（主观体验）。
- recent 列表正确更新且持久化；刷新页面不丢失当前空间。
- 非成员调用 visit 返回 403；未登录返回 401。

### 2.2 AI 智能解析（P0）

**现状问题**
- /api/ai/parse-requirement 仅关键词匹配，无法输出高质量结构化数据。

**功能要求**
- 使用 DeepSeek（兼容 OpenAI SDK）实现结构化解析：
  - title（<=50 字）、description、priority、status、tags[]
- 输入校验：空值/超长/非法字段，返回 400。
- 未配置 DEEPSEEK_API_KEY 时必须可降级到本地关键词解析，确保功能可用与向后兼容。

**非功能要求**
- AI 解析需要缓存（例如 30 分钟 TTL）以降低成本与抖动。
- 增加限流（例如 10 次/分钟/用户）避免滥用。

**验收标准**
- 有 Key：对典型中文/英文描述输出可解析 JSON；priority/status/tags 有合理推断。
- 无 Key：仍返回 parsed，形状与历史兼容。
- 不泄露 API Key；日志不输出敏感字段。

### 2.3 看板拖拽（P0）

**现状问题**
- 看板组件提示“拖拽需求到这里”，但无拖拽实现。

**功能要求**
- 支持卡片跨列拖拽，拖拽结束后通过 API 更新 status。
- 兼容点击进入详情（或通过卡片操作打开 Quick Edit）。
- 同列排序（若实现 order）：拖拽可调整顺序，刷新后顺序保持一致。

**数据/接口变更**
- Prisma：Requirement 增加 order（默认值、可用于排序）。
- 若实现同列排序：需要服务端接口支持更新 order（可复用 PUT /api/requirements/[id]）。

**验收标准**
- 跨列拖拽后状态即时刷新且与数据库一致。
- 刷新页面不回退到旧状态。

### 2.4 快速编辑（P1）

**功能要求**
- 快速编辑弹窗：标题、描述、状态、优先级；保存后 UI 即时更新。
- Quick Edit 内提供“AI 优化标题”（调用新接口 suggest-title）。
- 交互需避免破坏已有“详情页编辑/查看”路径（向后兼容）。

**验收标准**
- 保存成功后无需跳转即可看到更新；失败有可理解的提示（不要求强依赖 toast）。

### 2.5 命令面板（P1）

**功能要求**
- Ctrl/⌘K 打开面板，支持搜索工作空间与常用操作（创建工作空间/打开设置等）。
- 选中工作空间后应切换当前工作空间并关闭面板。

**验收标准**
- 快捷键可靠触发，输入与过滤无明显卡顿。

### 2.6 全局快捷键（P1）

**功能要求（最小集）**
- C：创建新需求
- /：聚焦搜索框（如果存在）
- E：对“当前选中/最近访问/列表首项”触发快速编辑（实现方式允许调整，但需可用）
- Ctrl/⌘1-4：切换到最近工作空间

**验收标准**
- 不与浏览器/系统关键快捷键冲突；输入框聚焦时不误触（可通过限定 scope 处理）。

### 2.7 需求模板（P2）

**功能要求**
- 提供内置模板列表（例如 BUG/FEATURE/OPTIMIZATION），一键生成标题/描述骨架。
- 可作为创建需求页的辅助入口。

### 2.8 语音输入（P2）

**功能要求**
- 前端支持语音转文字（可先实现浏览器 SpeechRecognition 的渐进增强）。
- 与 AI 解析结合：语音内容直接进入 parse-requirement。

### 2.9 批量导入（P2）

**功能要求**
- 提供导入接口 /api/requirements/import（JSON/CSV 任一即可；先实现 JSON）
- 支持基本字段校验与批量创建；部分失败需返回可定位错误。

## 3. 架构与模块影响评估（待实现阶段将逐项落地）

### 3.1 需要扩展/重构的模块

- Dashboard Layout：替换硬编码 currentWorkspace 逻辑，集成 WorkspaceSwitcher 与全局快捷键/命令面板入口。
- Workspaces API：排序逻辑、visit 写入接口、权限校验。
- Requirements Board：替换为可拖拽实现，并补齐 order 排序能力（若启用）。
- AI API：抽象 AI Client + cache + 降级策略；新增 suggest-title。
- Prisma Schema：新增字段与索引，确保兼容迁移策略。
- 测试与工程化：引入单测/集成/E2E 基建，覆盖率门槛与 CI 可运行性。

## 4. 分阶段升级计划（含交付物/时间节点/验收标准）

时间节点以“开发日”为单位估算，适用于 1 名开发者；并行可按团队扩展。

### 阶段 A（D1-D2）：P0 工作空间切换 + 数据模型

**交付物**
- Workspace Store（本地持久化 + recent）
- WorkspaceSwitcher 组件并集成到 Dashboard Layout
- /api/workspaces/[id]/visit + /api/workspaces 排序升级
- Prisma：Workspace.lastVisitedAt（nullable）与索引

**验收标准**
- 通过手动回归：切换空间、刷新保持、权限校验正确
- 单元/集成测试覆盖：store、visit API、workspaces list API

### 阶段 B（D3-D4）：P0 AI 解析升级

**交付物**
- DeepSeek Client（OpenAI SDK 兼容）
- /api/ai/parse-requirement 重写 + 缓存 + 限流 + 降级策略

**验收标准**
- Key/无 Key 两种场景均可工作
- 接口输入校验完善，覆盖常见错误用例

### 阶段 C（D5-D6）：P0 看板拖拽

**交付物**
- DraggableBoard + DraggableRequirementCard（跨列拖拽更新 status）
- Requirement.order（若启用）及同列排序写入逻辑

**验收标准**
- 拖拽后状态/顺序一致，刷新不回退
- 关键交互具备 E2E 覆盖（至少 1 条：拖拽->断言状态变化）

### 阶段 D（D7-D8）：P1 快速编辑 + 命令面板 + 快捷键

**交付物**
- QuickEditDialog + AI 标题建议接口
- CommandPalette（Ctrl/⌘K）
- GlobalHotkeys（C、E、/、Ctrl/⌘1-4）

**验收标准**
- 不破坏现有详情页路径；快捷键在可控范围内触发
- 对话框保存失败可复现并可理解（错误信息/状态）

### 阶段 E（D9-D10）：P2 增强功能

**交付物**
- 需求模板（创建页集成）
- 语音输入（渐进增强）
- 批量导入 API（JSON）

**验收标准**
- 功能可用、接口稳定、具备基础测试

### 阶段 F（D11-D12）：测试覆盖率 + 文档 + 回归/性能对比

**交付物**
- 单元/集成/E2E 测试体系落地，覆盖率 >= 80%
- README、API 文档、部署手册更新
- 回归测试报告与性能对比（>= 95% 基准），无 P1/P2 缺陷
- 升级总结报告（变更列表、风险点、后续优化建议）

## 5. 向后兼容性策略

- Prisma 新增字段均为 nullable 或有默认值，避免对旧数据造成破坏性迁移。
- 现有 API 语义保持不变：新增能力以“可选字段/新增接口”形式提供。
- AI 接口在未配置 Key 时降级到本地解析，保证功能可用性与开发体验。

