# 当前架构评估与改造点

本文档用于在实施升级前对现有项目的关键模块、职责边界与风险点进行总结，便于后续分阶段重构与验收。

## 1. 总体结构

- Next.js 15 App Router：页面与 API Route Handlers 同仓（[src/app](file:///d:/AI/openbd/src/app)）
- 数据访问：Prisma + MySQL（[prisma/schema.prisma](file:///d:/AI/openbd/prisma/schema.prisma)）
- 认证：cookie `auth-token` + middleware 注入 `x-user-id` / `x-user-username`（[middleware.ts](file:///d:/AI/openbd/src/middleware.ts)、[auth.ts](file:///d:/AI/openbd/src/lib/auth.ts)）
- UI：Tailwind + shadcn/ui，本地 UI 组件（[src/components/ui](file:///d:/AI/openbd/src/components/ui)）

## 2. 现有实现的主要瓶颈

### 2.1 状态与导航耦合

- Dashboard Layout 内部同时承担：用户信息获取、工作空间列表获取、当前工作空间选择、导航拼装与渲染（[layout.tsx](file:///d:/AI/openbd/src/app/(dashboard)/layout.tsx)）
- 当前工作空间选择硬编码为“总是第一个”，导致“切换空间”只能走列表页跳转，且体验抖动大。

### 2.2 API 使用方式分散

- 前端组件普遍直接 `fetch('/api/...')`，缺少统一的请求封装、错误归一化与重试策略（例如 [RequirementList.tsx](file:///d:/AI/openbd/src/components/requirements/RequirementList.tsx)、[AIRequirementCreator.tsx](file:///d:/AI/openbd/src/components/ai/AIRequirementCreator.tsx)）。
- 已引入 React Query 依赖但当前页面未落地使用，导致缓存/失效策略不一致。

### 2.3 看板交互缺失与数据排序能力不足

- 看板仅静态渲染，UI 文案提示拖拽但无实现（[RequirementBoard.tsx](file:///d:/AI/openbd/src/components/requirements/RequirementBoard.tsx)）。
- Requirement 模型缺少排序字段，导致同列顺序不可稳定持久化（[schema.prisma](file:///d:/AI/openbd/prisma/schema.prisma)）。

### 2.4 AI 能力处于 MVP

- AI 解析接口为关键词匹配，缺少真实模型、缓存、限流、以及“无 Key 可降级”的生产级策略（[parse-requirement/route.ts](file:///d:/AI/openbd/src/app/api/ai/parse-requirement/route.ts)）。

### 2.5 测试体系缺失

- 仓库当前几乎无单元/集成/E2E 自动化测试，升级后难以保障回归质量与兼容性。

## 3. 需要重构/扩展的模块（按优先级）

### 3.1 P0：工作空间切换链路

- UI：新增 WorkspaceSwitcher 组件并替换 Layout 内“显示当前空间名称”的静态实现。
- 状态：引入 store（Zustand）承担 workspaces/current/recent 的单一真相与持久化。
- API：新增 visit 写入接口；workspaces list 的排序基于 lastVisitedAt。
- 数据：Workspace 增加 lastVisitedAt 字段与索引。

### 3.2 P0：AI 解析链路

- lib：抽象 DeepSeek Client（兼容 OpenAI SDK），并封装缓存/限流/降级策略。
- API：重写 parse-requirement，同时新增 suggest-title。
- 前端：AIRequirementCreator 复用现有接口，无需破坏性改动。

### 3.3 P0：看板拖拽与排序链路

- UI：引入 dnd-kit；将现有看板替换为可拖拽实现。
- 数据：Requirement 增加 order（默认值），以支持稳定排序。
- API：在 status 更新与（可选）order 更新之间形成一致的更新策略，避免并发写入导致顺序错乱。

### 3.4 P1：效率体验增强

- 快速编辑：基于现有 PUT /api/requirements/[id] 增加原地编辑能力。
- 命令面板与快捷键：形成可发现的键盘工作流入口，减少页面跳转成本。

### 3.5 P2：高级能力

- 需求模板：纯前端即可先落地，后续可扩展为用户自定义模板。
- 语音输入：渐进增强，避免成为核心依赖路径。
- 批量导入：先提供 JSON 导入以满足自动化/对接需求，后续再扩展 CSV/Excel。

## 4. 兼容性与风险点

- Prisma 迁移：新增字段需确保 nullable 或 default，避免对现有数据产生破坏性影响。
- 路由替换 workspaceId：切换空间时需兼容不同页面路径结构（board/requirements/detail）。
- AI Key 配置：生产环境必须通过环境变量注入，且必须有无 Key 的降级策略用于本地开发与测试。

