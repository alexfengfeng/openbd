# 部署手册（staging/production）

## 1. 依赖与前提

- Node.js（建议 18+）
- MySQL 8.0
- pnpm

## 2. 环境变量

必须：

- `DATABASE_URL`：MySQL 连接串
- `JWT_SECRET`：至少 32 位随机字符串

可选：

- `DEEPSEEK_API_KEY`：启用 DeepSeek AI 解析；未配置时会自动降级到本地解析

## 3. 数据库初始化/迁移

首次部署：

```bash
pnpm install
pnpm db:generate
pnpm db:push
pnpm db:seed
```

后续迭代：

```bash
pnpm install
pnpm db:generate
pnpm db:push
```

## 4. 构建与运行

```bash
pnpm build
pnpm start
```

## 5. 测试与回归

- 单元/集成测试（含覆盖率门槛）：

```bash
pnpm test:coverage
```

- 端到端测试（Playwright）：

```bash
pnpm exec playwright install chromium
pnpm test:e2e
```

## 6. staging 建议流程

1. 使用独立 staging 数据库（避免污染生产数据）
2. 按生产配置构建并启动
3. 执行回归：
   - 登录/注册
   - 工作空间切换（含最近访问排序）
   - 列表与看板的创建/编辑/拖拽
   - AI 解析/标题建议（有 Key 与无 Key 两种路径）
4. 运行 `pnpm test:e2e` 作为最小回归门禁

